{% extends 'base.html' %}
{% block content %}
<div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow">
  <h2 class="text-lg font-semibold mb-4">Update Status</h2>

  {% if waste_to_assign %}
  <div class="mb-4">
    <p>Assign transport for waste <b>{{ waste_to_assign.waste_id }}</b> (Status: Collected)</p>
    <form method="post" class="mt-2 space-y-3">
      <input type="hidden" name="waste_id" value="{{ waste_to_assign.waste_id }}">
      <select name="transport_id" class="w-full border p-2 rounded">
        <option value="">Select Transport</option>
        {% for t in transports %}
        <option value="{{ t.transport_id }}">{{ t.transport_id }} ({{ t.transport_by }})</option>
        {% endfor %}
      </select>
      <button class="bg-blue-600 text-white px-4 py-2 rounded">Assign and set to In Transit</button>
    </form>
  </div>
  {% else %}
  <form method="post" class="space-y-3">
    <input name="code" placeholder="waste_id หรือ transport_id" class="w-full border p-3 rounded text-lg">
    <div class="flex gap-2 items-center">
      <select name="action" class="border p-2 rounded">
        <option value="">ติ๊ด (ไปสถานะถัดไปอัตโนมัติ)</option>
        <option>Collected</option>
        <option>In Transit</option>
        <option>Arrived Disposal Site</option>
        <option>In Disposal</option>
        <option>Completed</option>
      </select>
      <button class="bg-teal-600 text-white px-4 py-2 rounded">Update</button>
    </div>
  </form>
  {% endif %}

  {% if message %}<div class="mt-4 p-3 rounded bg-slate-100">{{ message }}</div>{% endif %}

  <div class="mt-4 text-sm text-slate-600">
    <b>Flow</b>: waste – Collected → In Transit → Arrived Disposal Site → In Disposal → Completed
  </div>
</div>

{% if wastes %}
<div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow mt-6">
    <h2 class="text-lg font-semibold mb-4">Waste in your hospital</h2>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><input type="checkbox" id="select-all-wastes"></th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waste ID</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Weight</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for item in wastes %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"><input type="checkbox" class="waste-checkbox" value="{{ item.waste.waste_id }}"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"><a href="{{ url_for('views.waste_detail', waste_id=item.waste.waste_id) }}" class="text-teal-600 hover:underline">{{ item.waste.waste_id }}</a></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.waste.waste_type }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ '%.2f'|format(item.waste.weight_kg) }} kg</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.status }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-4 flex items-center gap-2">
        <button id="bulk-advance-btn" class="btn btn-primary">Advance Selected to Next Stage</button>
        <select id="bulk-status-select" class="border p-2 rounded">
            <option value="">Set Selected to...</option>
            <option>Collected</option>
            <option>In Transit</option>
            <option>Arrived Disposal Site</option>
            <option>In Disposal</option>
            <option>Completed</option>
        </select>
        <button id="bulk-set-status-btn" class="btn btn-primary">Set Status</button>
    </div>
</div>
{% endif %}

<script>
    const selectAllCheckbox = document.getElementById('select-all-wastes');
    const wasteCheckboxes = document.querySelectorAll('.waste-checkbox');
    const bulkAdvanceBtn = document.getElementById('bulk-advance-btn');
    const bulkStatusSelect = document.getElementById('bulk-status-select');
    const bulkSetStatusBtn = document.getElementById('bulk-set-status-btn');

    selectAllCheckbox.addEventListener('change', function() {
        wasteCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    });

    function getSelectedWasteIds() {
        const selectedIds = [];
        wasteCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selectedIds.push(checkbox.value);
            }
        });
        return selectedIds;
    }

    async function performBulkAction(actionType, targetStatus = null) {
        const selectedIds = getSelectedWasteIds();
        if (selectedIds.length === 0) {
            alert('Please select at least one waste package.');
            return;
        }

        if (!confirm(`Are you sure you want to ${actionType === 'advance' ? 'advance' : 'set status to ' + targetStatus} ${selectedIds.length} waste package(s)?`)) {
            return;
        }

        try {
            const response = await fetch('/status/bulk_update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    waste_ids: selectedIds,
                    action: actionType,
                    target_status: targetStatus
                }),
            });

            const data = await response.json();

            if (response.ok) {
                alert(data.message);
                // Optionally refresh the page or update specific rows
                location.reload(); 
            } else {
                alert(`Error: ${data.message || 'An unknown error occurred.'}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to connect to the server.');
        }
    }

    bulkAdvanceBtn.addEventListener('click', () => {
        performBulkAction('advance');
    });

    bulkSetStatusBtn.addEventListener('click', () => {
        const targetStatus = bulkStatusSelect.value;
        if (!targetStatus) {
            alert('Please select a target status.');
            return;
        }
        performBulkAction('set_status', targetStatus);
    });
</script>
{% endblock %}
