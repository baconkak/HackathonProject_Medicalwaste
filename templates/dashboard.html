{% extends 'base.html' %} 
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="flex flex-wrap gap-3 items-end mb-4">
  <h2 class="text-lg font-semibold">
    Dashboard {% if hospital_name %}- {{ hospital_name }}{% endif %}
  </h2>
  <form class="flex gap-2 ml-auto" method="get">
    <input
      type="date"
      name="from"
      value="{{ dt_from.date() }}"
      class="border rounded p-1"
    />
    <input
      type="date"
      name="to"
      value="{{ dt_to.date() }}"
      class="border rounded p-1"
    />
    <button class="btn btn-primary">Apply</button>
    <a class="btn btn-primary" href="/export/excel">Export Excel</a>
    <a class="btn btn-danger" href="/export/pdf">Export PDF</a>
  </form>
</div>

<div class="grid md:grid-cols-4 gap-4">
  <div class="card">
    <div class="text-slate-600 text-sm">Total Bags</div>
    <div class="text-3xl font-bold">{{ total }}</div>
  </div>
  <div class="card">
    <div class="text-slate-600 text-sm">Completed %</div>
    <div class="text-3xl font-bold text-emerald-600 mb-2">
      {{ percent_completed }}%
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
      <div
        class="bg-emerald-600 h-2.5 rounded-full"
        style="width: {{ percent_completed }}%"
      ></div>
    </div>
  </div>
  <div class="card">
    <div class="text-slate-600 text-sm">By Type</div>
    <ul class="text-sm mt-1">
      {% for i in range(by_type_labels|length) %}
      <li class="flex justify-between"><span>{{ by_type_labels[i] }}:</span> <b>{{ by_type_data[i] }}</b></li>
      {% endfor %}
    </ul>
  </div>
  <div class="card incidents-card" id="incidents-card">
    <div class="text-slate-600 text-sm">Incidents</div>
    <ul class="text-sm mt-1 incidents-list">
      {% for inc in incidents %}
      <li
        class="{{ 'text-rose-600' if inc.type=='route_deviation' else 'text-amber-600' }}"
      >
        {{ inc.type }} â€“ {{ inc.ref_id }} ({{ inc.detail }})
      </li>
      {% else %}
      <li>No incidents</li>
      {% endfor %}
    </ul>
  </div>
</div>

<div class="grid md:grid-cols-2 gap-4 mt-4">
  <div class="card">
    <h3 class="font-semibold mb-2">Waste per day</h3>
    <canvas id="lineChart"></canvas>
  </div>
  <div class="card">
    <h3 class="font-semibold mb-2">Type distribution</h3>
    <canvas id="pieChart"></canvas>
  </div>
</div>

<div class="card mt-4">
  <h3 class="font-semibold mb-2">Waste Quantity Heatmap (kg)</h3>
  {% if heatmap_image_path %}
  <img src="{{ heatmap_image_path }}" alt="Waste Quantity Heatmap" class="w-full h-auto" />
  {% else %}
  <p>No heatmap data available.</p>
  {% endif %}
</div>

<div class="card mt-4">
  <h3 class="font-semibold mb-2">Cumulative Waste Graph</h3>
  {% if cumulative_waste_image_path %}
  <img src="{{ cumulative_waste_image_path }}" alt="Cumulative Waste Graph" class="w-full h-auto" />
  {% else %}
  <p>No cumulative waste data available.</p>
  {% endif %}
</div>

<div class="card mt-4" id="gpt-prediction-section">
  <h3 class="font-semibold mb-2">Ask OpenAI</h3>
  <div class="flex gap-2 mb-2">
    <button class="btn btn-primary" onclick="askGPT()">Analyze Data</button>
  </div>
  <div
    id="gptResponse"
    class="p-2 border rounded bg-gray-50 min-h-[50px]"
  ></div>
  <div id="gptLoading" class="hidden text-sm text-slate-500 mt-2">
    Loading...
  </div>
  <div id="gptError" class="hidden text-sm text-rose-600 mt-2"></div>
</div>

<div class="card mt-4">
  <h3 class="font-semibold">Latest</h3>
  <table class="table mt-2">
    <thead>
      <tr class="text-left border-b">
        <th>Time</th>
        <th>Waste</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for e in latest %}
      <tr class="border-b">
        <td>{{ e.at|fmt_dt }}</td>
        <td>
          <a class="text-teal-700 underline" href="/waste/{{ e.ref_id }}"
            >{{ e.ref_id }}</a
          >
        </td>
        <td>{{ e.status }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  const ts = {{ ts|tojson }};
  const byTypeLabels = {{ by_type_labels|tojson }};
  const byTypeData = {{ by_type_data|tojson }};

  new Chart(document.getElementById('lineChart'), {
    type: 'line',
    data: {
      labels: ts.map(x => x.day),
      datasets: [{ label: 'Bags', data: ts.map(x => x.count) }]
    }
  });

  new Chart(document.getElementById('pieChart'), {
    type: 'pie',
    data: {
      labels: byTypeLabels,
      datasets: [{ data: byTypeData }]
    }
  });

  async function askGPT() {
    const responseDiv = document.getElementById('gptResponse');
    const loadingDiv = document.getElementById('gptLoading');
    const errorDiv = document.getElementById('gptError');

    const question = "Analyze the provided waste management data and provide key insights, trends, and potential issues.";

    // Clear previous messages and show loading
    responseDiv.textContent = '';
    errorDiv.textContent = '';
    errorDiv.classList.add('hidden');
    loadingDiv.classList.remove('hidden');

    try {
      const response = await fetch('/api/ask-gpt', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ question: question }),
      });

      const data = await response.json();

      if (response.ok) {
        responseDiv.textContent = data.response;
      } else {
        errorDiv.textContent = data.error || 'An unknown error occurred.';
        errorDiv.classList.remove('hidden');
      }
    } catch (error) {
      errorDiv.textContent = 'Failed to connect to the server.';
      errorDiv.classList.remove('hidden');
      console.error('Error:', error);
    } finally {
      loadingDiv.classList.add('hidden');
    }
  }
</script>
{% endblock %}